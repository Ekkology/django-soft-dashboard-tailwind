<!DOCTYPE html>
<html>
{% load static %}
<head>
    <title>Crear Evento</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@4.4.0/dist/gridstack.min.css">
    <script src="https://cdn.jsdelivr.net/npm/gridstack@4.4.0/dist/gridstack-h5.min.js"></script>
    <style>
        .grid-stack-item-content {
            background-color: transparent;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px !important;
            height: 50px !important;
            position: relative;
        }
        .grid-stack {
            margin-top: 20px;
        }
        .seat-svg {
            width: 100%;
            height: auto;
        }
        .seat-number {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 12px;
            color: black;
        }
        .row-label {
            text-align: left;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .seat-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var grid = GridStack.init({
                float: true,
                cellHeight: 70,
                column: 10
            });

            document.getElementById('generateSeats').addEventListener('click', function() {
                var numSillas = parseInt(document.getElementById('num_sillas').value) || 0;
                
                // Limpiar las sillas anteriores
                document.querySelector('.grid-stack').innerHTML = '';

                // Calcular el número de sillas por fila
                var sillasPorFila = 10; // Ajusta según el diseño deseado
                var filas = Math.ceil(numSillas / sillasPorFila);

                var letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
                var seatCounter = 1;
                var rowIndex = 0;

                // Crear las filas y las sillas
                for (var y = 0; y < filas; y++) {
                    var rowContainer = document.createElement('div');
                    rowContainer.className = 'seat-container';

                    // Crear etiqueta de fila solo al comienzo de cada fila
                    if (rowIndex < letters.length) {
                        var rowLabel = document.createElement('div');
                        rowLabel.className = 'row-label';
                        rowLabel.textContent = "Row " + letters[rowIndex];
                        rowContainer.appendChild(rowLabel);
                        rowIndex++;
                    }

                    // Añadir sillas a la fila actual
                    for (var x = 0; x < sillasPorFila; x++) {
                        if (seatCounter > numSillas) break;

                        var el = document.createElement('div');
                        el.className = 'grid-stack-item';
                        el.innerHTML = `
                            <div class="grid-stack-item-content" id="silla${seatCounter}">
                                <img src="{% static 'assets/img/illustrations/silla_azul.svg' %}" class="seat-svg" />
                                <div class="seat-number">${seatCounter}</div>
                            </div>`;
                        el.setAttribute('data-gs-x', x);
                        el.setAttribute('data-gs-y', y);
                        el.setAttribute('data-gs-width', '1');
                        el.setAttribute('data-gs-height', '1');

                        rowContainer.appendChild(el);
                        seatCounter++;
                    }

                    document.querySelector('.grid-stack').appendChild(rowContainer);
                }
            });

            document.getElementById('saveConfig').addEventListener('click', function() {
                var items = [];
                grid.engine.nodes.forEach(function(node) {
                    items.push({
                        id: node.el.id,
                        posicion: {x: node.x, y: node.y},
                        estado: 'disponible'
                    });
                });

                var configuracion = {
                    tipo: 'rectangular',
                    sillas: items
                };

                fetch('/save_configuration/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ configuracion: configuracion })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Configuración guardada correctamente');
                    }
                });
            });
        });
    </script>
</head>
<body>
    <h1>Crear Evento</h1>
    <form method="post" id="eventForm">
        {% csrf_token %}
        <label for="num_sillas">Número de sillas:</label>
        <input type="number" id="num_sillas" name="num_sillas" min="0" required>
        <button type="button" id="generateSeats">Generar Sillas</button>
        <button type="button" id="saveConfig">Guardar Configuración</button>
    </form>
    <div class="grid-stack">
        <!-- Las sillas se agregarán dinámicamente -->
    </div>
</body>
</html>
