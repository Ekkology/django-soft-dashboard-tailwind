<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservación de Asientos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@4.4.0/dist/gridstack.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
    <h1 class="text-3xl font-bold text-center my-6">Reservación de Asientos para el Evento {{ evento.nombre }}</h1>

    <div class="flex justify-center items-center space-x-4 bg-white p-2 shadow-md rounded-lg mx-auto mb-6 max-w-sm w-full">
        <div class="flex items-center space-x-2">
            <img src="{% static 'assets/img/illustrations/silla_azul.svg' %}" alt="Disponible" class="w-6 h-6 md:w-8 md:h-8">
            <span class="text-sm md:text-base font-semibold text-blue-600">Disponible</span>
        </div>
        <div class="flex items-center space-x-2">
            <img src="{% static 'assets/img/illustrations/silla_roja.svg' %}" alt="Ocupada" class="w-6 h-6 md:w-8 md:h-8">
            <span class="text-sm md:text-base font-semibold text-red-600">Ocupada</span>
        </div>
    </div>

    <div class="grid-stack"></div>

    <script src="https://cdn.jsdelivr.net/npm/gridstack@4.4.0/dist/gridstack-h5.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const eventID = "{{ evento.id }}";
            const ws = new WebSocket(`ws://${window.location.host}/ws/event/${eventID}/`);

            const grid = GridStack.init({
                cellHeight: 80,
                disableResize: true,
                float: true
            });

            let seats;
            try {
                seats = JSON.parse('{{ configuracion.sillas|escapejs }}');
            } catch (error) {
                console.error('Error al analizar la configuración de sillas:', error);
                return;
            }

            seats.forEach(seat => {
                const el = document.createElement('div');
                el.classList.add('grid-stack-item');
                el.innerHTML = `
                    <div class="grid-stack-item-content ${seat.estado}" id="${seat.id}">
                        <img src="{% static 'assets/img/illustrations/silla_azul.svg' %}" class="seat-svg w-10 h-10 mx-auto" />
                    </div>`;
                grid.addWidget(el, { x: seat.posicion.x, y: seat.posicion.y, w: 1, h: 1 });

                el.addEventListener('click', () => {
                    const seatElement = document.getElementById(seat.id);
                    const status = seatElement.classList.contains('disponible');

                    console.log('Enviando mensaje:', { 'seat_id': seat.id, 'status': !status });

                    ws.send(JSON.stringify({
                        'seat_id': seat.id,
                        'status': !status
                    }));
                });
            });

            ws.onmessage = (e) => {
                if (!e.data) {
                    console.error('Mensaje vacío recibido');
                    return;
                }

                let data;
                try {
                    data = JSON.parse(e.data);
                } catch (error) {
                    console.error('Error al analizar JSON:', error, 'Datos:', e.data);
                    return;
                }

                const seatID = data.seat_id;
                const status = data.status;

                console.log('Mensaje recibido:', data);

                const seatElement = document.getElementById(seatID);
                if (seatElement) {
                    seatElement.className = `grid-stack-item-content ${status ? 'reservado' : 'disponible'}`;
                    seatElement.querySelector('.seat-svg').src = status ? '{% static "assets/img/illustrations/silla_roja.svg" %}' : '{% static "assets/img/illustrations/silla_azul.svg" %}';
                } else {
                    console.warn('No se encontró el elemento del asiento:', seatID);
                }
            };

            ws.onopen = () => {
                console.log('WebSocket conectado');
            };

            ws.onclose = (event) => {
                if (event.wasClean) {
                    console.log(`[close] Conexión cerrada limpiamente, código=${event.code}, razón=${event.reason}`);
                } else {
                    console.log('[close] Conexión muerta');
                }
            };

            ws.onerror = (error) => {
                console.error('Error en WebSocket:', error);
            };
        });
    </script>
</body>
</html>
